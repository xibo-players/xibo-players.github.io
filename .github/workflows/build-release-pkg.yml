name: Build xiboplayer-release packages

# Builds the xiboplayer-release RPM and DEB â€” the repo-config packages
# that users install to add the Xibo Players repository to their system.
#
# These packages ship a .repo/.sources file and GPG key, nothing else.
# Built packages are uploaded to a GitHub Release; update-repos.yml then
# fetches and indexes them alongside all other packages.

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build RPM + DEB
    runs-on: ubuntu-latest
    container:
      image: fedora:43

    steps:
      - name: Install git
        run: dnf install -y git

      - uses: actions/checkout@v4

      - name: Install tools
        run: dnf install -y rpm-build rpmdevtools dpkg dpkg-dev rpm-sign gnupg2 pinentry

      - name: Build RPM
        run: |
          rpmdev-setuptree

          # Copy sources (individual files, not a tarball)
          cp _repos/xiboplayer-release/xiboplayer.repo ~/rpmbuild/SOURCES/
          cp rpm/RPM-GPG-KEY ~/rpmbuild/SOURCES/RPM-GPG-KEY-xiboplayer

          # Build
          rpmbuild -bb _repos/xiboplayer-release/xiboplayer-release.spec

          # Copy to output
          mkdir -p dist
          find ~/rpmbuild/RPMS/ -name '*.rpm' -exec cp {} dist/ \;
          echo "RPM:"
          ls -lh dist/*.rpm

      - name: Build DEB
        run: |
          cd _repos/xiboplayer-release
          bash build-deb.sh
          cp *.deb ../../dist/
          cd ../..
          echo "DEB:"
          ls -lh dist/*.deb

      - name: Sign RPM
        env:
          GPG_KEY: ${{ secrets.RPM_GPG_KEY }}
          GPG_PASSPHRASE: ${{ secrets.RPM_GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.RPM_GPG_KEY_ID }}
        run: |
          # Import GPG private key (base64-encoded secret)
          echo "$GPG_KEY" | base64 -d | gpg --batch --import

          # Custom pinentry for non-interactive signing in CI
          printf '%s' "$GPG_PASSPHRASE" > /tmp/.gpg-passphrase
          chmod 600 /tmp/.gpg-passphrase
          cat > /usr/local/bin/pinentry-ci << 'PINENTRY'
          #!/bin/bash
          echo "OK Pleased to meet you"
          while IFS= read -r cmd; do
            case "${cmd%%\ *}" in
              GETPIN)
                echo "D $(cat /tmp/.gpg-passphrase)"
                echo "OK"
                ;;
              BYE)
                echo "OK"
                exit 0
                ;;
              *)
                echo "OK"
                ;;
            esac
          done
          PINENTRY
          chmod 755 /usr/local/bin/pinentry-ci

          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "pinentry-program /usr/local/bin/pinentry-ci" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true

          echo "%_gpg_name ${GPG_KEY_ID}" >> ~/.rpmmacros

          for rpm_file in dist/*.rpm; do
            echo "Signing: $(basename $rpm_file)"
            rpm --addsign "$rpm_file"
          done

          rm -f /tmp/.gpg-passphrase

          echo "Verifying signatures..."
          rpm -qpi dist/*.rpm | grep -E "^(Name|Signature)" || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*
          generate_release_notes: false
          body: |
            Repository configuration package for Xibo Players.

            Install with:
            ```
            sudo dnf install ./xiboplayer-release-*.noarch.rpm
            ```

      - name: Trigger update-repos
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.PAGES_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          dnf install -y curl
          curl -sf -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/xibo-players/xibo-players.github.io/dispatches" \
            -d '{"event_type": "update-repos", "client_payload": {"package": "xiboplayer-release", "repo": "xibo-players/xibo-players.github.io", "tag": "${{ github.ref_name }}"}}'
          echo "Triggered update-repos for xiboplayer-release"
